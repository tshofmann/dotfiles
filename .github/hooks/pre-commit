#!/usr/bin/env zsh
# ============================================================
# pre-commit - Git Pre-Commit Hook fÃ¼r dotfiles
# ============================================================
# Zweck       : Verhindert Commits mit veralteter Dokumentation,
#               ungÃ¼ltiger Shell-Syntax oder falscher Formatierung
# Pfad        : .github/hooks/pre-commit
# Install     : git config core.hooksPath .github/hooks
# WICHTIG     : --no-verify ist VERBOTEN (siehe copilot-instructions.md)
# ============================================================

set -uo pipefail

SCRIPT_DIR="${0:A:h}"
DOTFILES_DIR="${SCRIPT_DIR:h:h}"  # .github/hooks â†’ dotfiles
SHELL_COLORS="$DOTFILES_DIR/terminal/.config/theme-style"

# Farben (Catppuccin Mocha) â€“ zentral definiert
[[ -f "$SHELL_COLORS" ]] && source "$SHELL_COLORS"

# Logging (konsistent mit anderen Skripten)
log()  { echo -e "${C_BLUE:-}â†’${C_RESET:-} $1"; }
ok()   { echo -e "${C_GREEN:-}âœ”${C_RESET:-} $1"; }
warn() { echo -e "${C_YELLOW:-}âš ${C_RESET:-} $1"; }
err()  { echo -e "${C_RED:-}âœ–${C_RESET:-} $1" >&2; }

# ------------------------------------------------------------
# 1. Shell-Syntax prÃ¼fen
# ------------------------------------------------------------
check_shell_syntax() {
    log "PrÃ¼fe Shell-Syntax..."
    local errors=0

    # POSIX-Dateien zuerst mit sh -n prÃ¼fen (install.sh + logging.sh)
    for file in "$DOTFILES_DIR"/setup/install.sh \
                "$DOTFILES_DIR"/setup/lib/logging.sh; do
        if [[ -f "$file" ]]; then
            if ! sh -n "$file" 2>/dev/null; then
                err "POSIX-Syntax-Fehler in: ${file#$DOTFILES_DIR/}"
                sh -n "$file" 2>&1 | head -3
                (( errors++ )) || true
            fi
        fi
    done

    # ZSH-Dateien prÃ¼fen: .sh, .alias, .zsh, .zshrc, .zshenv, .zprofile, .zlogin
    # POSIX-Dateien (install.sh, logging.sh) werden Ã¼bersprungen
    for file in "$DOTFILES_DIR"/.github/scripts/**/*.sh(N) \
                "$DOTFILES_DIR"/terminal/.config/alias/*.alias(N) \
                "$DOTFILES_DIR"/terminal/.config/**/*.zsh(N) \
                "$DOTFILES_DIR"/terminal/.zsh*(N) \
                "$DOTFILES_DIR"/terminal/.zprofile(N) \
                "$DOTFILES_DIR"/terminal/.zlogin(N) \
                "$DOTFILES_DIR"/setup/bootstrap.sh(N) \
                "$DOTFILES_DIR"/setup/restore.sh(N) \
                "$DOTFILES_DIR"/setup/modules/*.sh(N); do
        if [[ -f "$file" ]]; then
            if ! zsh -n "$file" 2>/dev/null; then
                err "Syntax-Fehler in: ${file#$DOTFILES_DIR/}"
                zsh -n "$file" 2>&1 | head -3
                (( errors++ )) || true
            fi
        fi
    done

    if (( errors > 0 )); then
        err "$errors Datei(en) mit Syntax-Fehlern"
        return 1
    fi

    ok "Shell-Syntax OK"
    return 0
}

# ------------------------------------------------------------
# 2. Dokumentation prÃ¼fen
# ------------------------------------------------------------
check_docs() {
    log "PrÃ¼fe ob Dokumentation aktuell ist..."

    if ! "$DOTFILES_DIR/.github/scripts/generate-docs.sh" --check >/dev/null 2>&1; then
        err "Dokumentation ist veraltet!"
        print ""
        print "  ${C_DIM}Bitte ausfÃ¼hren:${C_RESET}"
        print "    ${C_BOLD}./.github/scripts/generate-docs.sh --generate${C_RESET}"
        print ""
        print "  ${C_DIM}Dann erneut committen.${C_RESET}"
        return 1
    fi

    ok "Dokumentation ist aktuell"
    return 0
}

# ------------------------------------------------------------
# 3. Execute-Berechtigungen prÃ¼fen (delegiert an gemeinsames Skript)
# ------------------------------------------------------------
check_executable_permissions() {
    "$DOTFILES_DIR/.github/scripts/check-executable-permissions.sh"
}

# ------------------------------------------------------------
# 4. Alias-Datei-Format prÃ¼fen (delegiert an gemeinsames Skript)
# ------------------------------------------------------------
check_alias_format() {
    "$DOTFILES_DIR/.github/scripts/check-alias-format.sh"
}

# ------------------------------------------------------------
# 5. Header-EinrÃ¼ckungen prÃ¼fen (delegiert an gemeinsames Skript)
# ------------------------------------------------------------
check_header_alignment() {
    "$DOTFILES_DIR/.github/scripts/check-header-alignment.sh"
}

# ------------------------------------------------------------
# 6. Plattform-Sync prÃ¼fen (delegiert an gemeinsames Skript)
# ------------------------------------------------------------
check_platform_sync() {
    "$DOTFILES_DIR/.github/scripts/check-platform-sync.sh"
}

# ------------------------------------------------------------
# 7. Markdown-Lint prÃ¼fen
# ------------------------------------------------------------
check_markdown() {
    log "PrÃ¼fe Markdown-Dateien..."

    # markdownlint-cli2 verfÃ¼gbar?
    if ! command -v markdownlint-cli2 >/dev/null 2>&1; then
        warn "markdownlint-cli2 nicht gefunden â€“ Ã¼bersprungen"
        warn "Installieren mit: brew install markdownlint-cli2"
        return 0  # Kein Fehler, nur Warnung
    fi

    # Markdownlint ausfÃ¼hren (Ausgabe nur bei Fehlern)
    local output
    output=$(markdownlint-cli2 --config "$DOTFILES_DIR/terminal/.config/markdownlint-cli2/.markdownlint-cli2.jsonc" '**/*.md' '#node_modules' 2>&1)
    local exit_code=$?

    if (( exit_code != 0 )); then
        err "Markdown-Fehler gefunden!"
        # Nur relevante Zeilen anzeigen (keine "Finding:", "Linting:", "Summary:")
        echo "$output" | grep -v "^Finding:" | grep -v "^Linting:" | grep -v "^Summary:" | grep -v "^markdownlint-cli2"
        print ""
        print "  ${C_DIM}Fehler beheben oder Generatoren anpassen:${C_RESET}"
        print "    ${C_BOLD}.github/scripts/generators/*.sh${C_RESET}"
        return 1
    fi

    ok "Markdown OK"
    return 0
}

# ------------------------------------------------------------
# 8. Health-Check ausfÃ¼hren (NUR lokal, nicht in CI)
# PrÃ¼ft reale Installation: Symlinks, Homebrew-Pakete, Fonts,
# Plattform-Abstraktionen, Theme-Dateien â€“ setzt vollstÃ¤ndiges
# Setup voraus, das in CI nicht vorhanden ist.
# Siehe auch: .github/workflows/validate.yml (Checks 1â€“7)
# ------------------------------------------------------------
check_health() {
    log "FÃ¼hre Health-Check aus..."

    local health_script="$DOTFILES_DIR/.github/scripts/health-check.sh"

    if [[ ! -f "$health_script" ]]; then
        err "health-check.sh nicht gefunden: $health_script"
        return 1
    fi

    if [[ ! -x "$health_script" ]]; then
        err "health-check.sh nicht ausfÃ¼hrbar â€“ chmod +x erforderlich"
        return 1
    fi

    # Health-Check ausfÃ¼hren (Ausgabe unterdrÃ¼cken, nur Exit-Code prÃ¼fen)
    if ! "$health_script" >/dev/null 2>&1; then
        err "Health-Check fehlgeschlagen!"
        print ""
        print "  ${C_DIM}Details anzeigen mit:${C_RESET}"
        print "    ${C_BOLD}./.github/scripts/health-check.sh${C_RESET}"
        return 1
    fi

    ok "Health-Check OK"
    return 0
}

# ------------------------------------------------------------
# Hauptprogramm
# ------------------------------------------------------------
print ""
print "${C_OVERLAY0}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${C_RESET}"
print "${C_MAUVE}ðŸ” ${C_BOLD}Pre-Commit Checks${C_RESET}"
print "${C_OVERLAY0}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${C_RESET}"
print ""

failed=0

check_shell_syntax || { (( failed++ )) || true; }
check_executable_permissions || { (( failed++ )) || true; }
check_docs || { (( failed++ )) || true; }
check_alias_format || { (( failed++ )) || true; }
check_header_alignment || { (( failed++ )) || true; }
check_platform_sync || { (( failed++ )) || true; }
check_markdown || { (( failed++ )) || true; }
check_health || { (( failed++ )) || true; }

print ""
print "${C_OVERLAY0}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${C_RESET}"

if (( failed > 0 )); then
    print ""
    err "Pre-Commit fehlgeschlagen (${C_BOLD}$failed${C_RESET}${C_RED} Check(s))"
    print ""
    print "  ${C_RED}${C_BOLD}--no-verify ist VERBOTEN!${C_RESET}"
    print "  ${C_DIM}Bitte Fehler beheben und erneut committen.${C_RESET}"
    exit 1
fi

print ""
ok "Alle Checks bestanden"
exit 0
