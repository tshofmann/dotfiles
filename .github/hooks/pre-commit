#!/usr/bin/env zsh
# ============================================================
# pre-commit - Git Pre-Commit Hook fÃ¼r dotfiles
# ============================================================
# Zweck   : Verhindert Commits mit veralteter Dokumentation
#           oder ungÃ¼ltiger Shell-Syntax
#
# Install : git config core.hooksPath .github/hooks
# WICHTIG : --no-verify ist VERBOTEN (siehe copilot-instructions.md)
# ============================================================

set -uo pipefail

SCRIPT_DIR="${0:A:h}"
DOTFILES_DIR="${SCRIPT_DIR:h:h}"  # .github/hooks â†’ dotfiles
SHELL_COLORS="$DOTFILES_DIR/terminal/.config/theme-style"

# Farben (Catppuccin Mocha) â€“ zentral definiert
[[ -f "$SHELL_COLORS" ]] && source "$SHELL_COLORS"

# Logging (konsistent mit anderen Skripten)
log()  { echo -e "${C_BLUE}â†’${C_RESET} $1"; }
ok()   { echo -e "${C_GREEN}âœ”${C_RESET} $1"; }
warn() { echo -e "${C_YELLOW}âš ${C_RESET} $1"; }
err()  { echo -e "${C_RED}âœ–${C_RESET} $1" >&2; }

# ------------------------------------------------------------
# 1. Shell-Syntax prÃ¼fen
# ------------------------------------------------------------
check_shell_syntax() {
    log "PrÃ¼fe Shell-Syntax..."
    local errors=0

    # Alle .sh und .alias Dateien prÃ¼fen
    for file in "$DOTFILES_DIR"/.github/scripts/**/*.sh(N) \
                "$DOTFILES_DIR"/terminal/.config/alias/*.alias(N) \
                "$DOTFILES_DIR"/setup/bootstrap.sh; do
        if [[ -f "$file" ]]; then
            if ! zsh -n "$file" 2>/dev/null; then
                err "Syntax-Fehler in: ${file#$DOTFILES_DIR/}"
                zsh -n "$file" 2>&1 | head -3
                (( errors++ ))
            fi
        fi
    done

    if (( errors > 0 )); then
        err "$errors Datei(en) mit Syntax-Fehlern"
        return 1
    fi

    ok "Shell-Syntax OK"
    return 0
}

# ------------------------------------------------------------
# 2. Dokumentation prÃ¼fen
# ------------------------------------------------------------
check_docs() {
    log "PrÃ¼fe ob Dokumentation aktuell ist..."

    if ! "$DOTFILES_DIR/.github/scripts/generate-docs.sh" --check >/dev/null 2>&1; then
        err "Dokumentation ist veraltet!"
        print ""
        print "  Bitte ausfÃ¼hren:"
        print "    ${C_YELLOW}./.github/scripts/generate-docs.sh --generate${C_RESET}"
        print ""
        print "  Dann erneut committen."
        return 1
    fi

    ok "Dokumentation ist aktuell"
    return 0
}

# ------------------------------------------------------------
# 3. Alias-Datei-Format prÃ¼fen (Guards, Header)
# ------------------------------------------------------------
check_alias_format() {
    log "PrÃ¼fe Alias-Datei-Format..."
    local errors=0

    for file in "$DOTFILES_DIR"/terminal/.config/alias/*.alias(N); do
        local name=$(basename "$file")

        # Header-Block vorhanden?
        if ! head -3 "$file" | grep -q "^# ===="; then
            err "$name: Kein Header-Block"
            (( errors++ ))
        fi

        # Guard-Check vorhanden?
        if ! grep -q "command -v.*>/dev/null" "$file"; then
            err "$name: Kein Guard-Check"
            (( errors++ ))
        fi
    done

    if (( errors > 0 )); then
        err "$errors Alias-Datei(en) mit Format-Fehlern"
        return 1
    fi

    ok "Alias-Format OK"
    return 0
}

# ------------------------------------------------------------
# 4. Markdown-Lint prÃ¼fen
# ------------------------------------------------------------
check_markdown() {
    log "PrÃ¼fe Markdown-Dateien..."

    # markdownlint-cli2 verfÃ¼gbar?
    if ! command -v markdownlint-cli2 >/dev/null 2>&1; then
        warn "markdownlint-cli2 nicht gefunden â€“ Ã¼bersprungen"
        warn "Installieren mit: brew install markdownlint-cli2"
        return 0  # Kein Fehler, nur Warnung
    fi

    # Markdownlint ausfÃ¼hren (Ausgabe nur bei Fehlern)
    local output
    output=$(markdownlint-cli2 --config "$DOTFILES_DIR/terminal/.config/markdownlint-cli2/.markdownlint-cli2.jsonc" '**/*.md' '#node_modules' 2>&1)
    local exit_code=$?

    if (( exit_code != 0 )); then
        err "Markdown-Fehler gefunden!"
        # Nur relevante Zeilen anzeigen (keine "Finding:", "Linting:", "Summary:")
        echo "$output" | grep -v "^Finding:" | grep -v "^Linting:" | grep -v "^Summary:" | grep -v "^markdownlint-cli2"
        print ""
        print "  Fehler beheben oder Generatoren anpassen:"
        print "    ${C_YELLOW}.github/scripts/generators/*.sh${C_RESET}"
        return 1
    fi

    ok "Markdown OK"
    return 0
}

# ------------------------------------------------------------
# Hauptprogramm
# ------------------------------------------------------------
print ""
print "${C_OVERLAY0}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${C_RESET}"
print "${C_MAUVE}ðŸ” Pre-Commit Checks${C_RESET}"
print "${C_OVERLAY0}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${C_RESET}"
print ""

failed=0

check_shell_syntax || (( failed++ ))
check_docs || (( failed++ ))
check_alias_format || (( failed++ ))
check_markdown || (( failed++ ))

print ""
print "${C_OVERLAY0}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${C_RESET}"

if (( failed > 0 )); then
    print ""
    err "Pre-Commit fehlgeschlagen ($failed Check(s))"
    print ""
    print "  ${C_RED}--no-verify ist VERBOTEN!${C_RESET}"
    print "  Bitte Fehler beheben und erneut committen."
    exit 1
fi

print ""
ok "Alle Checks bestanden"
exit 0
