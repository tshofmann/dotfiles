# ============================================================
# validate.yml - GitHub Actions Workflow
# ============================================================
# Zweck   : Validiert Shell-Syntax, Dokumentation und Alias-Format
# Trigger : Push auf main, PRs nach main, manuell
# ============================================================

name: Dokumentation validieren

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manuelles Triggern ermöglichen

jobs:
  validate:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: ZSH-Syntax prüfen
        shell: zsh {0}
        run: |
          set -uo pipefail
          echo "Prüfe ZSH-Syntax (inkl. Alias-Dateien)..."
          errors=0
          for file in .github/scripts/**/*.sh(N) terminal/.config/alias/*.alias(N) terminal/.config/**/*.zsh(N) terminal/.zsh*(N) terminal/.zprofile(N) terminal/.zlogin(N) setup/bootstrap.sh(N) setup/restore.sh(N) setup/modules/*.sh(N); do
            if [[ -f "$file" ]]; then
              if ! zsh -n "$file" 2>/dev/null; then
                echo "✖ Syntax-Fehler: $file"
                zsh -n "$file" 2>&1 | head -3
                (( errors++ )) || true
              fi
            fi
          done
          if (( errors > 0 )); then
            echo "✖ $errors Datei(en) mit Syntax-Fehlern"
            exit 1
          fi
          echo "✔ Shell-Syntax OK"

      - name: POSIX-Syntax prüfen
        shell: bash
        run: |
          echo "Prüfe POSIX-Shell-Syntax..."
          errors=0
          for file in setup/install.sh setup/lib/logging.sh; do
            if [[ -f "$file" ]]; then
              if ! sh -n "$file" 2>/dev/null; then
                echo "✖ Syntax-Fehler: $file"
                sh -n "$file" 2>&1 | head -3
                errors=$((errors + 1))
              fi
            fi
          done
          if [[ $errors -gt 0 ]]; then
            echo "✖ $errors POSIX-Datei(en) mit Syntax-Fehlern"
            exit 1
          fi
          echo "✔ POSIX-Syntax OK"

      - name: Execute-Berechtigungen prüfen
        run: ./.github/scripts/check-executable-permissions.sh

      - name: Plattform-Sync prüfen
        run: ./.github/scripts/check-platform-sync.sh

      - name: Homebrew Cache
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-homebrew-${{ hashFiles('setup/Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Homebrew-Pakete installieren
        run: |
          echo "Installiere benötigte Pakete..."
          brew install tealdeer markdownlint-cli2
          echo "✔ Pakete installiert"

      - name: tealdeer Cache initialisieren
        run: |
          echo "Initialisiere tealdeer Cache für tldr-Patch/Page-Erkennung..."
          tldr --update
          echo "✔ tealdeer Cache bereit"

      - name: Dokumentation prüfen
        run: |
          echo "Prüfe ob Dokumentation aktuell ist..."
          if ! ./.github/scripts/generate-docs.sh --check; then
            echo ""
            echo "✖ Dokumentation ist veraltet!"
            echo ""
            echo "Bitte lokal ausführen:"
            echo "  ./.github/scripts/generate-docs.sh --generate"
            echo ""
            exit 1
          fi
          echo "✔ Dokumentation ist aktuell"

      - name: Alias-Format prüfen
        shell: zsh {0}
        run: ./.github/scripts/check-alias-format.sh

      - name: Header-Einrückungen prüfen
        shell: zsh {0}
        run: ./.github/scripts/check-header-alignment.sh

      - name: Markdown prüfen
        run: |
          echo "Prüfe Markdown-Dateien..."
          # Config aus terminal/.config/ (wird lokal via Stow verlinkt)
          markdownlint-cli2 --config terminal/.config/markdownlint-cli2/.markdownlint-cli2.jsonc '**/*.md' '#node_modules'
          echo "✔ Markdown OK"
