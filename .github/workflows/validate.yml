# ============================================================
# validate.yml - GitHub Actions Workflow
# ============================================================
# Zweck   : Validiert Shell-Syntax, Dokumentation und Alias-Format
# Trigger : Push auf main, PRs nach main, manuell
# ============================================================

name: Dokumentation validieren

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manuelles Triggern ermöglichen

jobs:
  validate:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: ZSH-Syntax prüfen
        shell: zsh {0}
        run: |
          echo "Prüfe ZSH-Syntax (inkl. Alias-Dateien)..."
          errors=0
          for file in .github/scripts/**/*.sh terminal/.config/alias/*.alias terminal/.config/**/*.zsh setup/bootstrap.sh setup/restore.sh setup/modules/*.sh; do
            if [[ -f "$file" ]]; then
              if ! zsh -n "$file" 2>/dev/null; then
                echo "✖ Syntax-Fehler: $file"
                zsh -n "$file" 2>&1 | head -3
                errors=$((errors + 1))
              fi
            fi
          done
          if [[ $errors -gt 0 ]]; then
            echo "✖ $errors Datei(en) mit Syntax-Fehlern"
            exit 1
          fi
          echo "✔ Shell-Syntax OK"

      - name: POSIX-Syntax prüfen
        shell: bash
        run: |
          echo "Prüfe POSIX-Shell-Syntax..."
          errors=0
          for file in setup/install.sh setup/lib/logging.sh; do
            if [[ -f "$file" ]]; then
              if ! sh -n "$file" 2>/dev/null; then
                echo "✖ Syntax-Fehler: $file"
                sh -n "$file" 2>&1 | head -3
                errors=$((errors + 1))
              fi
            fi
          done
          if [[ $errors -gt 0 ]]; then
            echo "✖ $errors POSIX-Datei(en) mit Syntax-Fehlern"
            exit 1
          fi
          echo "✔ POSIX-Syntax OK"

      - name: Execute-Berechtigungen prüfen
        run: |
          echo "Prüfe Execute-Berechtigungen..."
          errors=0
          # fzf-Helper müssen ausführbar sein
          for file in terminal/.config/fzf/*; do
            name=$(basename "$file")
            [[ "$name" == "config" || "$name" == *.zsh ]] && continue
            if [[ -f "$file" && ! -x "$file" ]]; then
              echo "✖ fzf/$name: Fehlende Execute-Berechtigung"
              errors=$((errors + 1))
            fi
          done
          # Haupt-Skripte
          for file in setup/bootstrap.sh setup/install.sh .github/scripts/generate-docs.sh .github/scripts/health-check.sh; do
            if [[ -f "$file" && ! -x "$file" ]]; then
              echo "✖ $file: Fehlende Execute-Berechtigung"
              errors=$((errors + 1))
            fi
          done
          if [[ $errors -gt 0 ]]; then
            echo "✖ $errors Datei(en) ohne Execute-Berechtigung"
            exit 1
          fi
          echo "✔ Execute-Berechtigungen OK"

      - name: Plattform-Sync prüfen
        run: |
          echo "Prüfe Synchronisation platform.zsh ↔ install.sh..."
          errors=0

          # Distro-ID Case-Patterns extrahieren und vergleichen
          # Erfasst primäre IDs (z.B. fedora, debian|ubuntu|raspbian)
          # und ID_LIKE Fallbacks (z.B. *debian*, *fedora*)
          extract_patterns() {
            grep -E '^\s+[*a-z][a-z0-9|*]*\)\s+(echo\s+"(fedora|debian|arch)"|_PLATFORM_DISTRO="(fedora|debian|arch)")' "$1" | \
              sed 's/^[[:space:]]*//' | \
              sed 's/)[[:space:]]*.*//' | \
              sort
          }

          p_patterns=$(extract_patterns terminal/.config/platform.zsh)
          i_patterns=$(extract_patterns setup/install.sh)

          if [[ "$p_patterns" != "$i_patterns" ]]; then
            echo "✖ Distro-ID-Patterns nicht synchron!"
            echo ""
            echo "  platform.zsh:"
            echo "$p_patterns" | sed 's/^/    /'
            echo ""
            echo "  install.sh:"
            echo "$i_patterns" | sed 's/^/    /'
            echo ""
            echo "  Beide Dateien müssen identische case-Patterns haben."
            errors=$((errors + 1))
          fi

          # IDs-Zusammenfassung muss identisch sein
          p_comment=$(grep '# IDs:' terminal/.config/platform.zsh | head -1 | sed 's/^[[:space:]]*//')
          i_comment=$(grep '# IDs:' setup/install.sh | head -1 | sed 's/^[[:space:]]*//')

          if [[ "$p_comment" != "$i_comment" ]]; then
            echo "✖ IDs-Zusammenfassung nicht synchron:"
            echo "  platform.zsh: $p_comment"
            echo "  install.sh:   $i_comment"
            errors=$((errors + 1))
          fi

          if [[ $errors -gt 0 ]]; then
            echo ""
            echo "✖ $errors Sync-Fehler"
            echo "  Siehe SYNC-CHECK Kommentare in beiden Dateien."
            exit 1
          fi
          echo "✔ Plattform-Sync OK"

      - name: Homebrew Cache
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-homebrew-${{ hashFiles('setup/Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Homebrew-Pakete installieren
        run: |
          echo "Installiere benötigte Pakete..."
          brew install tealdeer markdownlint-cli2
          echo "✔ Pakete installiert"

      - name: tealdeer Cache initialisieren
        run: |
          echo "Initialisiere tealdeer Cache für tldr-Patch/Page-Erkennung..."
          tldr --update
          echo "✔ tealdeer Cache bereit"

      - name: Dokumentation prüfen
        run: |
          echo "Prüfe ob Dokumentation aktuell ist..."
          if ! ./.github/scripts/generate-docs.sh --check; then
            echo ""
            echo "✖ Dokumentation ist veraltet!"
            echo ""
            echo "Bitte lokal ausführen:"
            echo "  ./.github/scripts/generate-docs.sh --generate"
            echo ""
            exit 1
          fi
          echo "✔ Dokumentation ist aktuell"

      - name: Alias-Format prüfen
        run: |
          echo "Prüfe Alias-Datei-Format..."
          errors=0
          for file in terminal/.config/alias/*.alias; do
            name=$(basename "$file")

            # Header-Block vorhanden?
            if ! head -3 "$file" | grep -q "^# ===="; then
              echo "✖ $name: Kein Header-Block"
              errors=$((errors + 1))
            fi

            # Guard-Check vorhanden?
            if ! grep -q "command -v.*>/dev/null" "$file"; then
              echo "✖ $name: Kein Guard-Check"
              errors=$((errors + 1))
            fi
          done

          if [[ $errors -gt 0 ]]; then
            echo "✖ $errors Alias-Datei(en) mit Format-Fehlern"
            exit 1
          fi
          echo "✔ Alias-Format OK"

      - name: Markdown prüfen
        run: |
          echo "Prüfe Markdown-Dateien..."
          # Config aus terminal/.config/ (wird lokal via Stow verlinkt)
          markdownlint-cli2 --config terminal/.config/markdownlint-cli2/.markdownlint-cli2.jsonc '**/*.md' '#node_modules'
          echo "✔ Markdown OK"
