#!/usr/bin/env zsh
# ============================================================
# procs - Helper für procs() Funktion
# ============================================================
# Zweck       : Prozessliste für fzf
# Pfad        : ~/.config/fzf/procs
# Aufruf      : procs list [apps|all]
# ============================================================
# Hinweis     : macOS-spezifisch! Das Pattern \.app\/ filtert nach
#               macOS App-Bundles. Für Linux-Portabilität müsste
#               dieses Pattern durch Desktop-Anwendungserkennung
#               ersetzt werden (z.B. via .desktop-Dateien oder
#               /proc/<pid>/exe Symlink-Analyse).
# ============================================================

# Gemeinsame Bibliothek laden (Farben, ANSI-Strip)
source "${0:A:h}/lib.zsh"

# ------------------------------------------------------------
# Subcommand: list
# ------------------------------------------------------------
_procs_list() {
    local mode="${1:-apps}"

    if [[ "$mode" == "apps" ]]; then
        # Nur .app Prozesse (macOS-spezifisch – siehe Hinweis oben)
        # Prozessnamen können Leerzeichen enthalten → alles ab $4 als Pfad behandeln
        ps -u "$USER" -o pid,pcpu,pmem,comm | \
            awk '/\.app\// {
                pid=$1; cpu=$2; mem=$3
                $1=$2=$3=""
                sub(/^[[:space:]]+/, "")
                n=split($0,a,"/")
                printf "%7s %5s%% %5s%%  %s\n", pid, cpu, mem, a[n]
            }'
    else
        # Alle User-Prozesse
        # Prozessnamen können Leerzeichen enthalten → alles ab $4 als Pfad behandeln
        ps -u "$USER" -o pid,pcpu,pmem,comm | \
            awk 'NR>1 {
                pid=$1; cpu=$2; mem=$3
                $1=$2=$3=""
                sub(/^[[:space:]]+/, "")
                n=split($0,a,"/")
                printf "%7s %5s%% %5s%%  %s\n", pid, cpu, mem, a[n]
            }'
    fi
}

# ------------------------------------------------------------
# Usage
# ------------------------------------------------------------
_procs_usage() {
    cat <<EOF
Usage: procs <command> [args...]

Commands:
  list [apps|all]  Prozessliste generieren (Default: apps)

EOF
}

# ------------------------------------------------------------
# Main Dispatch
# ------------------------------------------------------------
_fzf_dispatch "procs" "$@"
