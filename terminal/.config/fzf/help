#!/usr/bin/env zsh
# ============================================================
# help - Helper für help() Funktion
# ============================================================
# Zweck       : Subcommands für man/tldr Browser
# Pfad        : ~/.config/fzf/help
# Aufruf      : help <list|preview|toggle> [args...]
# ============================================================
# Commands:
#   list [man|tldr]        – Listet Einträge
#   preview <mode> <entry> – Generiert Preview
#   toggle                 – Toggle-Logik für fzf Ctrl+S
# ============================================================

# Gemeinsame Bibliothek laden (Farben, ANSI-Strip)
source "${0:A:h}/lib.zsh"

# ------------------------------------------------------------
# Subcommand: list
# ------------------------------------------------------------
_help_list() {
    local mode="${1:-man}"

    case "$mode" in
        man)
            # Nur Sektion 1 (Benutzer-Kommandos)
            # Match nur echte Sektion-1-Einträge, nicht "(1)" in Beschreibungen
            man -k . 2>/dev/null | grep -E ' \(1\) |\(1\) '
            ;;
        tldr)
            tldr --list 2>/dev/null
            ;;
        *)
            echo "${C_RED}Unbekannter Modus:${C_RESET} $mode" >&2
            return 1
            ;;
    esac
}

# ------------------------------------------------------------
# Subcommand: preview
# ------------------------------------------------------------
_help_preview() {
    local mode="$1"
    local entry="$2"

    # Extrahiere Seitenname (alles vor der Klammer)
    local page=$(echo "$entry" | sed 's/(.*//' | tr -d ' ')

    if [[ "$mode" == "tldr" ]]; then
        tldr --color=always "$page" 2>/dev/null || echo "${C_RED}Keine tldr-Seite für${C_RESET} '$page'"
    else
        man "$page" 2>/dev/null | col -bx | bat --color=always -l man -p
    fi
}

# ------------------------------------------------------------
# Subcommand: toggle
# ------------------------------------------------------------
_help_toggle() {
    local fzf_dir="${XDG_CONFIG_HOME:-$HOME/.config}/fzf"

    # Query bleibt automatisch erhalten, first springt zum ersten Match
    if [[ "$FZF_PROMPT" == "man> " ]]; then
        echo "reload($fzf_dir/help list tldr)+change-prompt(tldr> )+change-preview($fzf_dir/help preview tldr {})+first"
    else
        echo "reload($fzf_dir/help list man)+change-prompt(man> )+change-preview($fzf_dir/help preview man {})+first"
    fi
}

# ------------------------------------------------------------
# Usage
# ------------------------------------------------------------
_help_usage() {
    cat <<EOF
Usage: help <command> [args...]

Commands:
  list [man|tldr]        Liste Einträge (Default: man)
  preview <mode> <entry> Generiere Preview für Eintrag
  toggle                 Toggle-Logik für fzf Ctrl+S

EOF
}

# ------------------------------------------------------------
# Main Dispatch
# ------------------------------------------------------------
_fzf_dispatch "help" "$@"
