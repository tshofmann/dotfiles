#!/usr/bin/env zsh
# Zweck   : Helper-Skript für fenv Ctrl+S Toggle (Reload-Befehl)
# Hinweis : Ausgelagert wegen komplexem Shell-Escaping in fzf --bind
# Quelle  : fzf.alias → fenv()

# Lade Shell-Farben
[[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/shell-colors" ]] && \
    source "${XDG_CONFIG_HOME:-$HOME/.config}/shell-colors"

# Argument: Pfad zur Statusdatei
tmpfile="${1:-/tmp/fenv-show-sys}"

# Aktuellen Modus lesen (0 = gefiltert, 1 = alle)
show_sys=$(cat "$tmpfile" 2>/dev/null || echo "0")

# Toggle: Modus umschalten
if [[ "$show_sys" == "0" ]]; then
    echo "1" > "$tmpfile"
    show_sys=1
else
    echo "0" > "$tmpfile"
    show_sys=0
fi

# Variablen filtern
filter_vars() {
    printenv | grep -E '^[a-zA-Z_][a-zA-Z0-9_]*=' | sort | \
    if [[ "$show_sys" == "0" ]]; then
        grep -v -E '^(_[^=]|__CF[^=]|TERM_SESSION[^=])'
    else
        cat
    fi
}

# Farbkodierung (identisch zu _fenv_colorize in fzf.alias)
colorize_vars() {
    awk -F= -v mauve="$C_MAUVE" -v green="$C_GREEN" -v blue="$C_BLUE" \
        -v text="$C_TEXT" -v dim="$C_DIM" -v reset="$C_RESET" '{
        name = $1
        value = substr($0, index($0, "=") + 1)
        if (length(value) > 60) value = substr(value, 1, 57) "..."
        if (name ~ /^(PATH|FPATH|MANPATH|INFOPATH|.*_PATH|.*DIRS)$/)
            printf "%s%-20s%s │ %s%s%s\n", mauve, name, reset, dim, value, reset
        else if (name ~ /^(HOME|USER|SHELL|TERM|LANG|LC_)/)
            printf "%s%-20s%s │ %s%s%s\n", green, name, reset, text, value, reset
        else
            printf "%s%-20s%s │ %s%s%s\n", blue, name, reset, text, value, reset
    }'
}

# Ausgabe für fzf reload
filter_vars | colorize_vars
