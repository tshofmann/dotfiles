#!/usr/bin/env zsh
# ============================================================
# fa-preview - Helper für fa() Preview-Wechsel
# ============================================================
# Zweck   : Preview-Befehle für fa (Alias-Browser) in fzf
# Pfad    : ~/.config/fzf/fa-preview
# Quelle  : fzf.alias → fa()
# ============================================================
# Hinweis : Ausgelagert wegen komplexem Shell-Escaping in fzf --bind
#           Aufruf: zsh fa-preview <mode> <selection>
#           Modes : code, tldr
# ============================================================

# Gemeinsame Bibliothek laden (Farben, ANSI-Strip)
source "${0:A:h}/fzf-lib"

# ------------------------------------------------------------
# Argumente
# ------------------------------------------------------------
mode="${1:-code}"
selection="${2:-}"

if [[ -z "$selection" ]]; then
    echo "${C_RED}Fehler:${C_RESET} fa-preview benötigt eine Auswahl als zweites Argument." >&2
    exit 1
fi

# Extrahiere Name und Kategorie aus fzf-Zeile (ANSI-Codes entfernen)
line=$(echo "$selection" | _fzf_strip_ansi)
name=$(echo "$line" | awk '{print $1}')
cat=$(echo "$line" | awk '{print $3}')

# Alias-Datei ermitteln
alias_dir="${XDG_CONFIG_HOME:-$HOME/.config}/alias"
file="${alias_dir}/${cat}.alias"

# ------------------------------------------------------------
# Modi
# ------------------------------------------------------------
case "$mode" in
    code)
        # Code-Definition aus Alias-Datei extrahieren
        if [[ ! -f "$file" ]]; then
            echo "${C_RED}Datei nicht gefunden:${C_RESET} $file"
            exit 1
        fi
        
        # AWK-Skript: Sucht Alias oder Funktion mit vorangehendem Kommentar
        extracted=$(awk -v name="$name" '
            BEGIN { found=0; buffer=""; printing=0 }
            
            # Kommentar-Zeilen (eingerückt oder nicht) merken
            /^[[:space:]]*#/ { 
                if (!found) buffer = $0 "\n"
                next 
            }
            
            # Alias-Definition: alias name="..." oder alias name='\''...'\''
            $0 ~ "^alias[[:space:]]+" name "=" { 
                printf "%s%s\n", buffer, $0
                found=1; buffer=""
                next
            }
            
            # Funktions-Definition (auch eingerückt): name() {
            $0 ~ "^[[:space:]]*" name "\\(\\)" {
                printf "%s", buffer
                found=1; buffer=""
                printing=1
            }
            
            # Funktionskörper ausgeben
            printing { print }
            
            # Funktionsende (auch eingerückt): }
            printing && /^[[:space:]]*}/ { printing=0 }
            
            # Kein Match = Buffer zurücksetzen
            !found { buffer="" }
        ' "$file")
        
        # Syntax-Highlighting mit bat (falls verfügbar)
        if command -v bat >/dev/null 2>&1; then
            echo "$extracted" | bat --language=zsh --style=plain --color=always
        else
            echo "$extracted"
        fi
        ;;
        
    tldr)
        # tldr-Seite für die Tool-Kategorie anzeigen
        if command -v tldr >/dev/null 2>&1; then
            tldr --color=always "$cat" 2>/dev/null || echo "Keine tldr-Seite für ${C_MAUVE}${cat}${C_RESET}"
        else
            echo "${C_RED}tldr nicht installiert${C_RESET}"
        fi
        ;;
        
    *)
        echo "${C_RED}Unbekannter Modus:${C_RESET} $mode"
        echo "Verfügbar: code, tldr"
        exit 1
        ;;
esac
