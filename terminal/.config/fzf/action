#!/usr/bin/env zsh
# ============================================================
# action - Sichere Aktionen für fzf-Bindings
# ============================================================
# Zweck       : Führt Aktionen Shell-Injection-sicher aus
# Pfad        : ~/.config/fzf/action
# Aufruf      : action <command> "argument" [...]
# Nutzt       : platform.zsh (clip, xopen)
# ============================================================
# Commands: copy, edit, open, git-diff, git-restore, git-add,
#           zoxide-remove
# ============================================================

# Plattform-Abstraktionen laden (clip, xopen)
[[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/platform.zsh" ]] && \
    source "${XDG_CONFIG_HOME:-$HOME/.config}/platform.zsh"

case "${1:-}" in
    copy)
        # Pfad ins Clipboard kopieren
        shift
        if (( $+functions[clip] )); then
            printf '%s' "$1" | clip
        else
            printf '%s' "$1" | pbcopy  # Fallback für macOS
        fi
        ;;
    edit)
        # Datei im Editor öffnen (optional mit Zeile)
        shift
        file="$1"
        line="${2:-}"
        if [[ -n "$line" && "$line" =~ ^[1-9][0-9]*$ ]]; then
            ${EDITOR:-vim} -- "$file" "+$line"
        else
            ${EDITOR:-vim} -- "$file"
        fi
        ;;
    open)
        # Datei mit Standard-App öffnen
        shift
        if (( $+functions[xopen] )); then
            xopen "$1"
        else
            open -- "$1"  # Fallback für macOS
        fi
        ;;
    git-diff)
        # Git diff für Datei
        shift
        git diff --color=always -- "$1" | bat --style=numbers --color=always -l diff 2>/dev/null || git diff --color=always -- "$1"
        ;;
    git-restore)
        # Git restore für Datei(en)
        shift
        for file in "$@"; do
            git restore -- "$file"
        done
        ;;
    git-add)
        # Git add für Datei(en)
        shift
        for file in "$@"; do
            git add -- "$file"
        done
        ;;
    zoxide-remove)
        # Zoxide Eintrag entfernen
        shift
        zoxide remove -- "$1"
        ;;
    -h|--help)
        cat <<EOF
Usage: action <command> [args...]

Commands:
  copy <path>            Pfad ins Clipboard kopieren
  edit <file> [line]     Datei im Editor öffnen
  open <file>            Datei mit Standard-App öffnen
  git-diff <file>        Git diff für Datei anzeigen
  git-restore <files...> Git restore für Datei(en)
  git-add <files...>     Git add für Datei(en)
  zoxide-remove <path>   Zoxide Eintrag entfernen

EOF
        ;;
    "")
        echo "Usage: action <command> [args...]" >&2
        echo "Try 'action --help' for more information." >&2
        exit 1
        ;;
    *)
        echo "Unknown action: $1" >&2
        exit 1
        ;;
esac
