#!/usr/bin/env zsh
# ============================================================
# preview-file - Universelle Datei-Vorschau fÃ¼r fzf
# ============================================================
# Zweck   : Zeigt Vorschau fÃ¼r verschiedene Dateitypen
# Pfad    : ~/.config/fzf/preview-file
# Aufruf  : preview-file "datei" [zeile]
# Nutzt   : bat (Code), pdftotext (PDF), 7zz (Archive), identify (Bilder), ffprobe (Video)
# ============================================================
# Hinweis : Pfad wird als Argument Ã¼bergeben, nicht interpoliert
# ============================================================

local file="$1"
local line="${2:-}"

# Validierung: Datei muss existieren
if [[ ! -f "$file" ]]; then
    echo "Datei nicht gefunden: $file"
    return 1
fi

# MIME-Type ermitteln
local mime
mime=$(file --brief --mime-type -- "$file" 2>/dev/null)

# Dateierweiterung (lowercase)
local ext="${file:e:l}"

# ------------------------------------------------------------
# Archiv-Vorschau (7zz)
# ------------------------------------------------------------
case "$ext" in
    zip|7z|rar|tar|gz|xz|bz2|tgz|tbz2|zst)
        if command -v 7zz >/dev/null 2>&1; then
            echo "ðŸ“¦ Archiv-Inhalt:"
            7zz l -- "$file" 2>/dev/null | head -50
            return 0
        fi
        ;;
esac

# ------------------------------------------------------------
# PDF-Vorschau (poppler)
# ------------------------------------------------------------
if [[ "$mime" == "application/pdf" || "$ext" == "pdf" ]]; then
    if command -v pdftotext >/dev/null 2>&1; then
        echo "ðŸ“„ PDF-Vorschau (erste Seiten):"
        pdftotext -l 3 -layout -- "$file" - 2>/dev/null | head -80
        return 0
    fi
fi

# ------------------------------------------------------------
# Video-Vorschau (ffprobe)
# ------------------------------------------------------------
if [[ "$mime" == video/* || "$ext" =~ ^(mp4|mkv|avi|mov|webm|wmv|flv|m4v)$ ]]; then
    if command -v ffprobe >/dev/null 2>&1; then
        echo "ðŸŽ¬ Video-Info:"
        ffprobe -v quiet -show_format -show_streams -- "$file" 2>/dev/null | \
            grep -E '^(format_name|duration|width|height|codec_name|bit_rate)=' | \
            sed 's/^/  /'
        return 0
    fi
fi

# ------------------------------------------------------------
# Audio-Vorschau (ffprobe)
# ------------------------------------------------------------
if [[ "$mime" == audio/* || "$ext" =~ ^(mp3|flac|wav|ogg|m4a|aac|wma)$ ]]; then
    if command -v ffprobe >/dev/null 2>&1; then
        echo "ðŸŽµ Audio-Info:"
        ffprobe -v quiet -show_format -- "$file" 2>/dev/null | \
            grep -E '^(format_name|duration|bit_rate|TAG:)' | \
            sed 's/^TAG:/  ðŸ·ï¸  /' | sed 's/^/  /'
        return 0
    fi
fi

# ------------------------------------------------------------
# Bild-Vorschau (ImageMagick)
# ------------------------------------------------------------
if [[ "$mime" == image/* || "$ext" =~ ^(jpg|jpeg|png|gif|webp|svg|heic|tiff|bmp|ico)$ ]]; then
    if command -v identify >/dev/null 2>&1; then
        echo "ðŸ–¼ï¸  Bild-Info:"
        identify -verbose -- "$file" 2>/dev/null | \
            grep -E '^\s*(Geometry|Resolution|Colorspace|Type|Filesize|Format):' | \
            head -10
        return 0
    fi
fi

# ------------------------------------------------------------
# Text/Code-Vorschau (bat/cat)
# ------------------------------------------------------------
if [[ -n "$line" ]] && command -v bat >/dev/null 2>&1; then
    bat --color=always --highlight-line "$line" -- "$file" 2>/dev/null || cat -- "$file"
elif command -v bat >/dev/null 2>&1; then
    bat --style=numbers --color=always -- "$file" 2>/dev/null || cat -- "$file"
else
    cat -- "$file"
fi
