#!/usr/bin/env zsh
# ============================================================
# pre-commit - Git Hook f√ºr Validierung vor Commits
# ============================================================
# Pr√ºft:
#   1. Syntax-Check f√ºr .sh Dateien (zsh -n)
#   2. Doku-Konsistenz bei relevanten √Ñnderungen
#
# Install : git config core.hooksPath .githooks
# ============================================================

DOTFILES_DIR="$(git rev-parse --show-toplevel)"
changed_files=$(git diff --cached --name-only)

# ------------------------------------------------------------
# 1. Syntax-Check f√ºr Shell-Skripte
# ------------------------------------------------------------
sh_files=$(echo "$changed_files" | grep -E '\.sh$' || true)

if [[ -n "$sh_files" ]]; then
    echo "üîç Pr√ºfe Shell-Syntax..."
    syntax_errors=0
    
    while IFS= read -r file; do
        [[ -z "$file" ]] && continue
        filepath="$DOTFILES_DIR/$file"
        [[ -f "$filepath" ]] || continue
        
        if ! zsh -n "$filepath" 2>&1; then
            echo "  ‚úñ $file"
            ((syntax_errors++))
        else
            echo "  ‚úî $file"
        fi
    done <<< "$sh_files"
    
    if ((syntax_errors > 0)); then
        echo ""
        echo "‚ùå Commit abgebrochen: $syntax_errors Datei(en) mit Syntaxfehlern!"
        echo ""
        echo "Optionen:"
        echo "  1. Syntaxfehler beheben und erneut committen"
        echo "  2. Hook √ºberspringen: git commit --no-verify"
        exit 1
    fi
fi

# ------------------------------------------------------------
# 2. Dokumentations-Konsistenz
# ------------------------------------------------------------
if echo "$changed_files" | grep -qE '^(docs/|setup/Brewfile|terminal/.config/)'; then
    echo "üìñ Pr√ºfe Dokumentations-Konsistenz..."
    
    if ! "$DOTFILES_DIR/scripts/validate-docs.sh"; then
        echo ""
        echo "‚ùå Commit abgebrochen: Dokumentation stimmt nicht mit Code √ºberein!"
        echo ""
        echo "Optionen:"
        echo "  1. Dokumentation aktualisieren und erneut committen"
        echo "  2. Hook √ºberspringen: git commit --no-verify"
        exit 1
    fi
fi

exit 0
