#!/usr/bin/env zsh
# ============================================================
# pre-commit - Git Hook fÃ¼r Validierung vor Commits
# ============================================================
# Aktionen:
#   1. Syntax-Check fÃ¼r ZSH-Dateien (zsh -n)
#      - *.sh, *.alias, .zshrc, .zshenv, .zprofile, .zlogin, pre-commit
#   2. Dokumentations-Generierung bei relevanten Ã„nderungen
#      - Generiert Docs aus Code (Single Source of Truth)
#      - Staged generierte Dateien automatisch
#
# Install : git config core.hooksPath .githooks
# ============================================================

DOTFILES_DIR="$(git rev-parse --show-toplevel)"
changed_files=$(git diff --cached --name-only)

# ------------------------------------------------------------
# 1. Syntax-Check fÃ¼r ZSH-Dateien
# ------------------------------------------------------------
# Alle Dateien die zsh-Syntax enthalten
zsh_files=$(echo "$changed_files" | grep -E '\.(sh|alias)$|\.zshrc$|\.zshenv$|\.zprofile$|\.zlogin$|^\.githooks/pre-commit$' || true)

if [[ -n "$zsh_files" ]]; then
    echo "ðŸ” PrÃ¼fe ZSH-Syntax..."
    syntax_errors=0
    
    while IFS= read -r file; do
        [[ -z "$file" ]] && continue
        filepath="$DOTFILES_DIR/$file"
        [[ -f "$filepath" ]] || continue
        
        if ! zsh -n "$filepath" 2>&1; then
            echo "  âœ– $file"
            ((syntax_errors++))
        else
            echo "  âœ” $file"
        fi
    done <<< "$zsh_files"
    
    if ((syntax_errors > 0)); then
        echo ""
        echo "âŒ Commit abgebrochen: $syntax_errors Datei(en) mit Syntaxfehlern!"
        echo ""
        echo "Optionen:"
        echo "  1. Syntaxfehler beheben und erneut committen"
        echo "  2. Hook Ã¼berspringen: git commit --no-verify"
        exit 1
    fi
fi

# ------------------------------------------------------------
# 2. Dokumentations-Generierung
# ------------------------------------------------------------
# Trigger bei: Alias-Dateien, Brewfile, Configs, Bootstrap
# Generator erzeugt Docs neu und staged sie automatisch
if echo "$changed_files" | grep -qE '^(terminal/\.config/alias/|setup/Brewfile|setup/bootstrap\.sh|terminal/\.config/fzf/)'; then
    echo "ðŸ“– Generiere Dokumentation..."
    
    if ! "$DOTFILES_DIR/scripts/generate-docs.sh" --generate; then
        echo ""
        echo "âŒ Commit abgebrochen: Dokumentations-Generator fehlgeschlagen!"
        echo ""
        echo "Optionen:"
        echo "  1. Fehler beheben und erneut committen"
        echo "  2. Hook Ã¼berspringen: git commit --no-verify"
        exit 1
    fi
    
    # Generierte Dateien automatisch stagen
    git add "$DOTFILES_DIR/README.md" \
            "$DOTFILES_DIR/docs/tools.md" \
            "$DOTFILES_DIR/docs/installation.md" \
            "$DOTFILES_DIR/docs/architecture.md" \
            "$DOTFILES_DIR/docs/configuration.md" \
            "$DOTFILES_DIR/terminal/.config/tealdeer/pages/"*.patch.md 2>/dev/null || true
    
    echo "âœ” Dokumentation generiert und gestaged"
fi

exit 0
